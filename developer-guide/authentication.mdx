---
title: Authentication
description: Authentication and authorization setup guide
---

# Authentication

This document describes how to set up authentication and authorization for working with the Google Cloud infrastructure.

## Overview

Authentication to Google Cloud Platform can be done through several methods:

1. **Application Default Credentials (ADC)**: Recommended for local development
2. **Service Accounts**: For applications and CI/CD
3. **User Accounts**: For interactive use
4. **Workload Identity**: For GKE workloads

## Application Default Credentials (ADC)

### Setup

ADC automatically finds credentials in this order:

1. `GOOGLE_APPLICATION_CREDENTIALS` environment variable
2. User credentials from `gcloud auth application-default login`
3. Service account attached to the resource (GCE, GKE, Cloud Run)

### Local Development

```bash
# Login with your user account
gcloud auth application-default login

# Verify credentials
gcloud auth application-default print-access-token
```

### Using Service Account Key

```bash
# Set environment variable
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/service-account-key.json"

# Verify
gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
```

## Service Accounts

### Creating Service Accounts

```bash
# Create service account
gcloud iam service-accounts create app-service \
  --display-name="Application Service Account" \
  --description="Service account for application workloads"

# Grant permissions
gcloud projects add-iam-policy-binding PROJECT_ID \
  --member="serviceAccount:app-service@PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/cloudsql.client"
```

### Service Account Keys

```bash
# Create key
gcloud iam service-accounts keys create key.json \
  --iam-account=app-service@PROJECT_ID.iam.gserviceaccount.com

# Use key
export GOOGLE_APPLICATION_CREDENTIALS="key.json"
```

**⚠️ Security Note**: Store keys securely, never commit to version control.

### Terraform Service Accounts

```hcl
resource "google_service_account" "app_service" {
  account_id   = "app-service"
  display_name = "Application Service Account"
}

resource "google_project_iam_member" "app_service_permissions" {
  project = var.project_id
  role    = "roles/cloudsql.client"
  member  = "serviceAccount:${google_service_account.app_service.email}"
}
```

## Workload Identity (GKE)

### Setup

Workload Identity allows GKE pods to use service accounts without keys.

```hcl
resource "google_service_account" "workload" {
  account_id   = "workload-identity"
  display_name = "Workload Identity Service Account"
}

resource "google_service_account_iam_member" "workload_identity" {
  service_account_id = google_service_account.workload.name
  role               = "roles/iam.workloadIdentityUser"
  member             = "serviceAccount:${var.project_id}.svc.id.goog[default/app-service]"
}
```

### Kubernetes Service Account

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-service
  annotations:
    iam.gke.io/gcp-service-account: workload-identity@PROJECT_ID.iam.gserviceaccount.com
```

## Terraform Authentication

### Using Application Default Credentials

```hcl
provider "google" {
  project = var.project_id
  region  = var.region
}
```

Terraform will use ADC automatically.

### Using Service Account Key

```hcl
provider "google" {
  project     = var.project_id
  region      = var.region
  credentials = file(var.credentials_file)
}
```

### Backend Authentication

```hcl
terraform {
  backend "gcs" {
    bucket = "terraform-state-bucket"
    prefix = "agentic-ai-infrastructure"
  }
}
```

Backend uses ADC or `GOOGLE_APPLICATION_CREDENTIALS`.

## Required Permissions

### Terraform Permissions

Minimum permissions for Terraform:

- `roles/editor` (for creating resources)
- `roles/iam.serviceAccountAdmin` (for service accounts)
- `roles/storage.admin` (for state bucket)

### Application Permissions

Grant minimal permissions:

```hcl
resource "google_project_iam_member" "app_permissions" {
  project = var.project_id
  role    = "roles/cloudsql.client"
  member  = "serviceAccount:${google_service_account.app.email}"
}
```

## Secret Manager Access

### Reading Secrets

```python
from google.cloud import secretmanager

def get_secret(project_id, secret_id):
    client = secretmanager.SecretManagerServiceClient()
    name = f"projects/{project_id}/secrets/{secret_id}/versions/latest"
    response = client.access_secret_version(request={"name": name})
    return response.payload.data.decode("UTF-8")
```

### Required IAM Role

```hcl
resource "google_secret_manager_secret_iam_member" "secret_access" {
  secret_id = google_secret_manager_secret.api_key.secret_id
  role      = "roles/secretmanager.secretAccessor"
  member    = "serviceAccount:${google_service_account.app.email}"
}
```

## Cloud SQL Access

### Private IP Connection

```hcl
resource "google_sql_database_instance" "main" {
  settings {
    ip_configuration {
      ipv4_enabled    = false
      private_network = google_compute_network.main.id
    }
  }
}
```

### Cloud SQL Proxy

```bash
# Download Cloud SQL Proxy
curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.linux.amd64
chmod +x cloud-sql-proxy

# Run proxy
./cloud-sql-proxy INSTANCE_CONNECTION_NAME
```

### Application Connection

```python
import sqlalchemy

def create_connection():
    db_user = os.environ.get("DB_USER")
    db_pass = get_secret(PROJECT_ID, "db-password")
    db_name = os.environ.get("DB_NAME")
    db_socket_dir = os.environ.get("DB_SOCKET_DIR", "/cloudsql")
    instance_connection_name = os.environ.get("INSTANCE_CONNECTION_NAME")
    
    pool = sqlalchemy.create_engine(
        sqlalchemy.engine.url.URL.create(
            drivername="postgresql+pg8000",
            username=db_user,
            password=db_pass,
            database=db_name,
            query={
                "unix_sock": f"{db_socket_dir}/{instance_connection_name}/.s.PGSQL.5432"
            }
        )
    )
    return pool
```

## API Authentication

### 11Labs API

```python
from google.cloud import secretmanager
import requests

def get_elevenlabs_api_key():
    client = secretmanager.SecretManagerServiceClient()
    name = f"projects/{PROJECT_ID}/secrets/elevenlabs-api-key/versions/latest"
    response = client.access_secret_version(request={"name": name})
    return response.payload.data.decode("UTF-8")

def call_elevenlabs_api(text):
    api_key = get_elevenlabs_api_key()
    headers = {
        "xi-api-key": api_key,
        "Content-Type": "application/json"
    }
    # Make API call
    response = requests.post(
        "https://api.elevenlabs.io/v1/text-to-speech/VOICE_ID",
        json={"text": text},
        headers=headers
    )
    return response
```

## Troubleshooting

### Common Issues

**Authentication Error**
```
Error: google: could not find default credentials
```

**Solution**: Run `gcloud auth application-default login`

**Permission Denied**
```
Error: Permission denied on resource
```

**Solution**: Check IAM permissions and roles

**Service Account Key Not Found**
```
Error: open /path/to/key.json: no such file or directory
```

**Solution**: Verify `GOOGLE_APPLICATION_CREDENTIALS` path

### Verifying Authentication

```bash
# Check current account
gcloud auth list

# Check application default credentials
gcloud auth application-default print-access-token

# Test API access
curl -H "Authorization: Bearer $(gcloud auth print-access-token)" \
  https://cloudresourcemanager.googleapis.com/v1/projects
```

## Best Practices

1. **Use ADC**: Prefer Application Default Credentials
2. **Service Accounts**: Use service accounts for applications
3. **Least Privilege**: Grant minimal necessary permissions
4. **No Keys in Code**: Never hardcode credentials
5. **Secret Manager**: Store secrets in Secret Manager
6. **Workload Identity**: Use Workload Identity for GKE
7. **Rotate Keys**: Regularly rotate service account keys
8. **Audit Access**: Monitor and audit credential usage

## Next Steps

- [Setup Guide](/developer-guide/setup) - Initial setup
- [Deployment](/developer-guide/deployment) - Deployment guide
- [Security IAM](/security/iam) - IAM configuration

---

**Related Documentation**:
- [Prerequisites](/developer-guide/prerequisites)
- [Local Development](/developer-guide/local-development)

