---
title: Compute Services
description: Compute Engine, Cloud Run, and GKE configuration
---

# Compute Services

This document describes the compute services used in the infrastructure: Compute Engine, Cloud Run, and Google Kubernetes Engine (GKE).

## Compute Engine

### Overview

Compute Engine provides virtual machines (VMs) running on Google's infrastructure.

### Configuration

```hcl
resource "google_compute_instance" "main" {
  name         = "app-server"
  machine_type = "e2-standard-4"
  zone         = var.zone

  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-11"
      size  = 20
      type  = "pd-standard"
    }
  }

  network_interface {
    network    = google_compute_network.main.name
    subnetwork = google_compute_subnetwork.main.name

    access_config {
      // Ephemeral public IP
    }
  }

  service_account {
    email  = google_service_account.app.email
    scopes = ["cloud-platform"]
  }

  metadata = {
    startup-script = file("${path.module}/startup.sh")
  }

  tags = ["http-server", "https-server"]
}
```

### Managed Instance Groups

```hcl
resource "google_compute_instance_template" "main" {
  name         = "app-template"
  machine_type = "e2-standard-4"

  disk {
    source_image = "debian-cloud/debian-11"
    auto_delete  = true
    boot         = true
  }

  network_interface {
    network = google_compute_network.main.name
  }
}

resource "google_compute_instance_group_manager" "main" {
  name               = "app-group"
  base_instance_name = "app"
  zone               = var.zone
  target_size        = 3

  version {
    instance_template = google_compute_instance_template.main.id
  }

  auto_healing_policies {
    health_check      = google_compute_health_check.main.id
    initial_delay_sec = 300
  }
}

resource "google_compute_autoscaler" "main" {
  name   = "app-autoscaler"
  zone   = var.zone
  target = google_compute_instance_group_manager.main.id

  autoscaling_policy {
    max_replicas    = 10
    min_replicas    = 3
    cooldown_period = 60

    cpu_utilization {
      target = 0.8
    }
  }
}
```

## Cloud Run

### Overview

Cloud Run is a fully managed serverless platform for running containers.

### Configuration

```hcl
resource "google_cloud_run_service" "app" {
  name     = "app"
  location = var.region

  template {
    spec {
      containers {
        image = "gcr.io/${var.project_id}/app:latest"

        ports {
          container_port = 8080
        }

        env {
          name  = "DATABASE_URL"
          value = google_sql_database_instance.main.connection_name
        }

        resources {
          limits = {
            cpu    = "1000m"
            memory = "512Mi"
          }
        }
      }

      service_account_name = google_service_account.app.email
    }

    metadata {
      annotations = {
        "autoscaling.knative.dev/maxScale" = "100"
        "run.googleapis.com/cloudsql-instances" = google_sql_database_instance.main.connection_name
      }
    }
  }

  traffic {
    percent         = 100
    latest_revision = true
  }
}

resource "google_cloud_run_service_iam_member" "public" {
  service  = google_cloud_run_service.app.name
  location = google_cloud_run_service.app.location
  role     = "roles/run.invoker"
  member   = "allUsers"
}
```

### Custom Domains

```hcl
resource "google_cloud_run_domain_mapping" "app" {
  location = var.region
  name     = "app.example.com"

  metadata {
    namespace = var.project_id
  }

  spec {
    route_name = google_cloud_run_service.app.name
  }
}
```

## Google Kubernetes Engine (GKE)

### Overview

GKE provides managed Kubernetes clusters for container orchestration.

### Configuration

```hcl
resource "google_container_cluster" "main" {
  name     = "main-cluster"
  location = var.region

  remove_default_node_pool = true
  initial_node_count       = 1

  network    = google_compute_network.main.name
  subnetwork = google_compute_subnetwork.main.name

  workload_identity_config {
    workload_pool = "${var.project_id}.svc.id.goog"
  }

  addons_config {
    http_load_balancing {
      disabled = false
    }
    horizontal_pod_autoscaling {
      disabled = false
    }
  }
}

resource "google_container_node_pool" "main" {
  name       = "main-pool"
  location   = var.region
  cluster    = google_container_cluster.main.name
  node_count = 3

  node_config {
    preemptible  = false
    machine_type = "e2-standard-4"

    service_account = google_service_account.gke.email
    oauth_scopes = [
      "https://www.googleapis.com/auth/cloud-platform"
    ]
  }

  autoscaling {
    min_node_count = 3
    max_node_count = 10
  }

  management {
    auto_repair  = true
    auto_upgrade = true
  }
}
```

### Workload Identity

```hcl
resource "google_service_account" "gke" {
  account_id   = "gke-service"
  display_name = "GKE Service Account"
}

resource "google_service_account_iam_member" "workload_identity" {
  service_account_id = google_service_account.gke.name
  role               = "roles/iam.workloadIdentityUser"
  member             = "serviceAccount:${var.project_id}.svc.id.goog[default/app-service]"
}
```

## Best Practices

### Security

- Use service accounts with minimal permissions
- Enable Workload Identity for GKE
- Use private IPs when possible
- Enable Shielded VMs

### Performance

- Right-size instances
- Use preemptible instances for non-critical workloads
- Implement auto-scaling
- Use regional persistent disks for HA

### Cost Optimization

- Use committed use discounts
- Right-size resources
- Use preemptible instances
- Implement resource scheduling

## Next Steps

- [Storage Services](/services/storage) - Storage configuration
- [Networking Services](/services/networking) - Network configuration
- [Monitoring Services](/services/monitoring) - Monitoring setup

---

**Related Documentation**:
- [Architecture Overview](/architecture/overview)
- [Terraform Modules](/terraform/modules)

